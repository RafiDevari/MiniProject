<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cek Kandungan Gizi</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen">
    <div class="text-center">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">Cek Kandungan Gizi</h1>
        <p class="text-gray-600 mb-6">Ambil gambar makanan Anda dan dapatkan informasi kandungan gizinya.</p>
        <button id="openCameraButton" onclick="openCamera()" class="bg-blue-500 text-white px-6 py-3 rounded-lg shadow-md hover:bg-blue-600 transition">Buka Kamera</button>
    </div>

    <div class="mt-6" id="cameraContainer" style="display: none;">
        <video id="camera" autoplay class="border rounded-lg shadow-md"></video>
        <button onclick="captureImage()" class="mt-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-md hover:bg-green-600 transition">Ambil Gambar</button>
    </div>

    <canvas id="canvas" style="display: none;"></canvas>
    <div id="previewContainer" class="mt-6 text-center" style="display: none;">
        <img id="previewImage" class="border rounded-lg shadow-md max-w-xs" />
        <div class="mt-4">
            <button onclick="retakeImage()" class="bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-yellow-600 transition">Ambil Ulang</button>
            <button onclick="uploadImage()" class="bg-green-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-600 transition">Kirim Gambar</button>
        </div>
    </div>

    <!-- Tempat menampilkan hasil -->
    <div id="jsonOutput" class="mt-6 text-center max-w-md" style="display: none;"></div>

    <script>
        function openCamera() {
            document.getElementById('cameraContainer').style.display = 'block';
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('openCameraButton').style.display = 'none';
            const video = document.getElementById('camera');
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => { video.srcObject = stream; })
                .catch(error => console.error("Error accessing camera: ", error));
        }

        function captureImage() {
            const video = document.getElementById('camera');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageUrl = canvas.toDataURL("image/jpeg");
            document.getElementById('previewImage').src = imageUrl;
            document.getElementById('previewContainer').style.display = 'block';
            document.getElementById('cameraContainer').style.display = 'none';
        }

        function retakeImage() {
            document.getElementById('previewContainer').style.display = 'none';
            openCamera();
        }

        function uploadImage() {
            const canvas = document.getElementById('canvas');
            canvas.toBlob(blob => {
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = function() {
                    const base64data = reader.result.split(',')[1];
                    fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            "contents": [{
                                "parts": [
                                    { "text": "Berdasarkan gambar ini, berikan informasi kandungan gizinya dalam format JSON sebagai berikut,Berikan saran dalam saat makan makanan kemasan ini seperti seberapa sehat makanan ini dan lain lain.Jika foto ini tidak mengandung kandungan nutrisi,buat nilai null  jika ada yang 0mg buat 0 mg tetap.BERIKAN HANYA JSONNYA:\n{\n\"kalori\": \" \",\n\"lemak_total\": \" \",\n\"lemak_jenuh\": \" \",\n\"kolesterol\": \" \",\n\"protein\": \" \",\n\"karbohidrat\": \" \",\n\"gula\": \" \",\n\"garam\": \" \",\n\"saran\": \" \"}" },
                                    { "inline_data": { "mime_type": "image/jpeg", "data": base64data } }
                                ]
                            }]
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        try {
                            let textResponse = data.candidates[0].content.parts[0].text;
                            textResponse = textResponse.replace(/```json/g, "").replace(/```/g, "").trim();
                            const parsedData = JSON.parse(textResponse);

                            // Menampilkan hasil dengan desain
                            const output = `
                                <div class="bg-white shadow-md rounded-lg p-4">
                                    <h2 class="text-xl font-bold mb-2">Hasil Kandungan Gizi</h2>
                                    <p><strong>Kalori:</strong> ${parsedData.kalori}</p>
                                    <p><strong>Lemak Total:</strong> ${parsedData.lemak_total}</p>
                                    <p><strong>Lemak Jenuh:</strong> ${parsedData.lemak_jenuh}</p>
                                    <p><strong>Kolesterol:</strong> ${parsedData.kolesterol}</p>
                                    <p><strong>Protein:</strong> ${parsedData.protein}</p>
                                    <p><strong>Karbohidrat:</strong> ${parsedData.karbohidrat}</p>
                                    <p><strong>Gula:</strong> ${parsedData.gula}</p>
                                    <p><strong>Garam:</strong> ${parsedData.garam}</p>
                                    <div class="mt-4 p-3 rounded-lg ${parsedData.saran ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-700'}">
                                        <strong>Saran:</strong> ${parsedData.saran ? parsedData.saran : "Masukkan gambar yang benar"}
                                    </div>
                                </div>
                            `;

                            document.getElementById('jsonOutput').style.display = 'block';
                            document.getElementById('jsonOutput').innerHTML = output;
                        } catch (error) {
                            console.error("Parsing error:", error);
                            document.getElementById('jsonOutput').style.display = 'block';
                            document.getElementById('jsonOutput').innerHTML = "<div class='bg-red-100 text-red-700 p-3 rounded-lg'>Terjadi kesalahan saat memproses data.</div>";
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        document.getElementById('jsonOutput').style.display = 'block';
                        document.getElementById('jsonOutput').innerHTML = "<div class='bg-red-100 text-red-700 p-3 rounded-lg'>Terjadi kesalahan saat mengambil data.</div>";
                    });
                };
            }, "image/jpeg");
        }
    </script>
</body>
</html>
